{% extends 'base.html' %}

{% block content %}

    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
        var $button = $("<div id='source-button' " +
                "class='btn btn-primary btn-xs remove_button' " +
                {#                "style='position: absolute; right:5px; top:0px'" +#}
                ">Remove</div>").click(function(){

            var id = $(this).parent().data().id;
            var collection_id = $(this).parent().data().collection_id;

            $.ajax({
                type: "POST",
                url: "{% url 'user_profile.save_image' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    image_id: id,
                    collection_id: collection_id,
                    {#                    id.split('_')[2],#}
                    delete_image: true
                },
                success: function(data) {
                    alert("Removed Image");
                    $('#bl_item_' + id).remove();
                    $('.js-masonry').masonry();
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert("Problem removing Image: "+errorThrown+xhr.status+xhr.responseText);
                }
            });

        });

        $(document).ready(function(){
            $('.js-masonry').masonry();

            $('.bl_item').hover(function(){
                $(this).append($button);
                $button.show();
            }, function(){
                $button.hide();
            });

            $('#download_all').click(function(){
                var dl_link = '{% url 'user_dl_all' %}' +
                        '?csrfmiddlewaretoken=' +
                        document.getElementsByName('csrfmiddlewaretoken')[0].value +
                        '&collection_ids=' +
                        '{% for id, data in images.items %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}';
                window.open(dl_link, '_blank');
            });

            $('.dl_collection').click(function(){
                var collection_id = $(this).data('collection_id');
                var dl_link = '{% url 'dl_collection' %}' +
                        '?csrfmiddlewaretoken=' +
                        document.getElementsByName('csrfmiddlewaretoken')[0].value +
                        '&collection_id=' + collection_id;
                window.open(dl_link, '_blank');
            });

            $('#share_all_dialogue').dialog({
                autoOpen: false,
                width: $(window).width() * 0.7,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "blind",
                    duration: 500
                }
            });

            $('.share_all').click(function(){
                var collection_id = $(this).data('collection_id');
                var link = '{% url 'dl_collection' %}?' +
                        'collection_id=' + collection_id;
                $('#share_collection_ref').attr('href', link).text('http://lost-visions.cf.ac.uk' + link);
{#                $('#edit_collection_dialog_form').dialog("open");#}
                $('#share_all_dialogue').dialog("open");

{#                window.open("{% url 'tweet_card' %}", '_blank');#}
            });

            $('.edit_collection').click(function(){
                var collection_id = $(this).data('collection_id');
                var collection_name = $(this).data('collection_name');

                $('#edit_collection_data').data('collection_id', collection_id).data('collection_name', collection_name);

                $('#edit_collection_dialog_form').data('id', collection_id).data('name', collection_name).dialog("open");


            });

            var dialog = $( "#edit_collection_dialog_form" ).dialog({
                autoOpen: false,
                height: 300,
                width: 350,
                modal: true,
                buttons: {
                    "Rename collection": function() {
                        var id = $(this).data('id');
                        var new_collection_name = $('#rename_collection_field').val();
                        var name = $(this).data('name');

                        $.ajax({
                            type: "POST",
                            url: "{% url 'manage_collection' %}",
                            data: {
                                csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                                collection_id: id,
                                collection_name: new_collection_name,
                                action: 'rename'
                            },
                            success: function(data) {
                                dialog.dialog( "close" );
                                alert('Renamed collection ' + name + ' to ' + new_collection_name);
                                location.reload();
                            },
                            error: function(xhr, textStatus, errorThrown) {}
                        });
                    },
                    "Delete collection": function() {
                        var id = $(this).data('id');
                        var name = $(this).data('name');

                        $.ajax({
                            type: "POST",
                            url: "{% url 'manage_collection' %}",
                            data: {
                                csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                                collection_id: id,
                                action: 'delete'
                            },
                            success: function(data) {
                                dialog.dialog( "close" );
                                alert('Deleted collection ' + name);
                                location.reload();
                            },
                            error: function(xhr, textStatus, errorThrown) {}
                        });                    },
                    Cancel: function() {
                        dialog.dialog( "close" );
                    }
                },
                open : function() {
                    var name = $(this).data('name');
                    var id = $(this).data('id');
                    $('#rename_collection_field').val(name);
                },
                close: function() {
                    {#                form[ 0 ].reset();#}
                    {#                allFields.removeClass( "ui-state-error" );#}
                }
            });

        });
        $(window).load(function(){
            $('.js-masonry').masonry();
        });


    </script>

    <div id="share_all_dialogue" title="Share Entire Image Collection">
        Share this URL : <br>
        <a id="share_collection_ref" href="{% url 'dl_collection' %}">http://lost-visions.cf.ac.uk{% url 'dl_collection' %}</a>
        <br><br>

    </div>

    <div class="col-xs-12 col-sm-6">
        <div class="bs-example table-responsive">
            <table class="table table-striped table-hover">
                <tr>
                    <td>Number of Images you have tagged : </td>
                    <td>{{ metrics.user_tagged_image_number }}</td>
                </tr>
                <tr>
                    <td>Number of tags you have produced : </td>
                    <td>{{ metrics.user_tags_number }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="col-xs-12 col-sm-6">
        <div class="bs-example table-responsive">
            <table class="table table-striped table-hover">
                <tr>
                    <td>Total number of tagged images : </td>
                    <td>{{ metrics.total_tagged_image_number }}</td>
                </tr>
                <tr>
                    <td>Total number of image tags : </td>
                    <td>{{ metrics.total_tags_number }}</td>
                </tr>
            </table>
        </div>
    </div>

    <hr>

    <h3>Your Saved Images :</h3>

    {#    <form action="{% url 'user_dl_all' %}" method="get">{% csrf_token %}#}
    {#        <input type="hidden" name="collection_ids" value="{% for id, data in images.items %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}"/>#}
    {#        <button type="submit" class="btn btn-default">Download All</button>#}
    {#    </form>#}
    {#    <hr>#}

    {#    <table>#}
    {#        <tr>#}
    {#            <td>#}
    {#                <div id="download_all" class="btn btn-default">Download all</div>#}
    {#            </td>#}
    {#            <td>#}
    {#                <div id="share_all" class="btn btn-warning">Share this collection</div>#}
    {#            </td>#}
    {#            <td>#}
    {#                <div style="padding: 10px; margin-top: 10px">#}
    {#                    <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://lost-visions.cf.ac.uk{% url 'user_dl_all' %}?collection_ids={% for id, data in images.items %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}" data-text="I'm sharing an Image collection with the @Lost_Visions project" data-via="lost_visions" data-size="large">Tweet</a>#}
    {#                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>#}
    {#                </div>#}
    {#            </td>#}
    {#        </tr>#}
    {#    </table>#}
    {#    <hr>#}
    {#    <div id="result-container" class="js-masonry"#}
    {#         data-masonry-options='{"columnWidth": 100, "itemSelector": ".bl_item" }'>#}
    {#        <br>#}
    {#        {% for saved_image_key, saved_image_data in images.items %}#}
    {#            <div class="bl_item" id="bl_item_{{ saved_image_key }}" data-id="{{ saved_image_key }}">#}
    {#                <div class="panel">#}
    {#                    <a href="{% url 'image' saved_image_key %}" target="_blank">#}
    {#                        <img src="{{ saved_image_data.url }}" style='width:100%; height:auto;'>#}
    {#                    </a>#}
    {#                    <div class="panel-footer">#}
    {#                        Image ID : {{ saved_image_key }}#}
    {#                        <br>#}
    {#                        Page : {{ saved_image_data.page }}#}
    {#                    </div>#}
    {#                </div>#}
    {#            </div>#}
    {#        {% empty %}#}
    {#            <div class="bl_item" >#}
    {#                (You have not yet saved any images)#}
    {#            </div>#}
    {#        {% endfor %}#}
    {#    </div>#}


    {% for k, b in users_collections.items %}

        <h3>{{ b.collection_name }}</h3>
        <table>
            <tr>
                <td>
                    <div id="edit_collection_{{ k }}"
                         data-collection_id="{{ k }}"
                         data-collection_name="{{ b.collection_name }}"
                         class="btn btn-default edit_collection">Edit Collection</div>
                </td>
                <td>
                    <div id="download_collection{{ k }}" data-collection_id="{{ k }}"
                         class="btn btn-default dl_collection">Download Collection</div>
                </td>
                <td>
                    <div id="share_all" data-collection_id="{{ k }}" class="btn btn-warning share_all">Share</div>
                </td>
                <td>
                    <div style="padding: 10px; margin-top: 10px">
                        <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://lost-visions.cf.ac.uk{% url 'dl_collection' %}?collection_id={{ k }}" data-text="I'm sharing an Image collection with the @Lost_Visions project" data-via="lost_visions" data-size="large">Tweet</a>
                        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                    </div>
                </td>
            </tr>
        </table>


        <div id="result-container" class="js-masonry"
             data-masonry-options='{"columnWidth": 100, "itemSelector": ".bl_item" }'>
            {% for d in b.images %}
                <div class="bl_item" id="bl_item_{{ d.flickr_id }}"
                     data-id="{{ d.flickr_id }}" data-collection_id="{{ k }}">
                    <div class="panel">
                        <a href="{% url 'image' d.flickr_id %}" target="_blank">
                            <img src="{{ d.url }}" style='width:100%; height:auto;'>
                        </a>
                        <div class="panel-footer">
                            Image ID : {{ d.flickr_id }}
                            <br>
                            Page : {{ d.page }}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        <hr>
    {% empty %}
        <div class="bl_item" >
            (You have not yet saved any images)
        </div>
        <hr>
    {% endfor %}

    {#    {{ users_collections }}#}
    <div id="edit_collection_dialog_form" title="Edit this collection">
        <p class="validateTips">Edit collection details</p>
        <div id="edit_collection_data" data-collection_id="" data-collection_name=""></div>
        <form>
            <fieldset>
                <label for="rename_collection_field">New Name</label>
                <input type="text" name="rename_collection_field" id="rename_collection_field" value="" class="text ui-widget-content ui-corner-all">

                <!-- Allow form submission with keyboard without duplicating the dialog button -->
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>
{% endblock %}