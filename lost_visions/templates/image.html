{% extends "base.html" %}
{% load staticfiles %}
{% load url from future %}

{% block content %}
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true"></script>

    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">

    $(window).load(function(){
        $('.js-masonry').masonry();
    });

    $(window).resize(function(){
        $('.js-masonry').masonry();
    });

    function getDefaultFontSize(pa){
        pa= pa || document.body;
        var who= document.createElement('div');

        who.style.cssText='display:inline-block; padding:0; line-height:1; position:absolute; visibility:hidden; font-size:1em';

        who.appendChild(document.createTextNode('M'));
        pa.appendChild(who);
        var fs= [who.offsetWidth, who.offsetHeight];
        pa.removeChild(who);
        return fs;
    }

    var font_size = getDefaultFontSize()[1];

    {#    function getFontSize(small, big, value) {#}
    {#        return font_size + ((value -1) * (10 / {{ most_used_tag_count }}) * font_size);#}
    {#    }#}

    function tidy_masonry() {

        setTimeout("$('#category-container').masonry()", 1500);
        $('#category-container').masonry();
    }

    function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds){
                break;
            }
        }
    }

    function get_similar_images(image_id) {
        $.ajax({
            type: "POST",
            url: "{% url 'image.similar_images' image_id%}",
            data: {
                csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                image_id: image_id
            },
            success: function(data) {
                var ok = data['success'];
                console.log(data);

                var similars = '<ul id="similars_list">';
                for (var img_data in data['largest_set']) {
                    similars += '<li>';
                    similars += '<a href="' + data['largest_set'][img_data]['link']  + '" target="_blank">';
                    similars += '<img src="' + data['largest_set'][img_data]['img_small'] +
                            '" class="similar-image"></img>';
                    similars += '</a>';
                    similars += '</li>';
                }
                similars += '</ul>';
                $('#similars').html(similars);

                if (data['largest_set_size'] == "0") {
                    $('#collapse_similars').accordion({active: false});
                }

                var book_images = '<ul id="book_images_list">';
                for (var img_data in data['book_images']) {
                    book_images += '<li>';
                    book_images += '<a href="' + data['book_images'][img_data]['link']  + '" target="_blank">';
                    book_images += '<img src="' + data['book_images'][img_data]['img_small'] +
                            '" class="similar-image"></img>';
                    book_images += '</a>';
                    book_images += '</li>';
                }
                book_images += '</ul>';
                $('#book_images').html(book_images);


                var machine_matched = '<ul id="machine_matched_list">';
                for (var img_data in data['machine_matches']) {
                    machine_matched += '<li>';
                    machine_matched += '<a href="' + data['machine_matches'][img_data]['link']  + '" target="_blank">';
                    machine_matched += '<img src="' + data['machine_matches'][img_data]['img_small'] +
                            '" class="similar-image"></img>';
                    machine_matched += '</a>';
                    machine_matched += '</li>';
                }
                machine_matched += '</ul>';
                $('#machine_matched_images').html(machine_matched);

            },
            error: function(xhr, textStatus, errorThrown) {
                console.log("Problem with category: "+errorThrown+xhr.status+xhr.responseText);
            }
        });
    }

    function add_tag_button(tag_string, synset) {
        console.log(tag_string + ' : ' + synset);
        var id = 'id_' + tag_string;

        var $button_toggle = '<div class="btn btn-success tag-button" data-toggle="tooltip" data-placement="right" title="Remove this Tag" data-original-title="Remove this Tag"'
                + 'id="' + id +
                '" name="' + tag_string +
                '" x_percent="' + hightlighted_x_percent +
                '" y_percent="' + hightlighted_y_percent + '">' + tag_string + '</div>';

        var d = new Date();
        var datetime = d.toISOString();
        all_tags.push({tag: tag_string,
            synset: synset,
            x_percent: hightlighted_x_percent,
            y_percent: hightlighted_y_percent,
            x_pixel: highlighted_x_pixel,
            y_pixel: highlighted_y_pixel,
            datetime: datetime,
            tag_order: all_tags.length
        });

        hightlighted_x_percent = 0;
        hightlighted_y_percent = 0;
        highlighted_x_pixel = 0;
        highlighted_y_pixel = 0;

        document.getElementById("tag_info").value = JSON.stringify(all_tags);
        {#                console.log(JSON.parse(document.getElementById("tag_info").value));#}

        {#                $("#add_tags_body").prepend($label).prepend($check);#}

        var button_toggle_component = $($button_toggle).click(function(){
            $(this).remove();
        }).tooltip();

        $("#add_tags_body").append(button_toggle_component);

    }

    {#    This is important #}
    var all_tags = [];

    var hightlighted_x_percent = 0;
    var hightlighted_y_percent = 0;
    var highlighted_x_pixel = 0;
    var highlighted_y_pixel = 0;

    var current_question_pane = 1;
    $(document).ready(function () {

        $('#tagging-submit-btn').click(function(event){

            {#            document.getElementById("tag_info").value#}
            $('#final_tags').empty();

            get_alt_tags(function(data) {
                document.getElementById("tag_info").value = JSON.stringify(data);


                var user_tags = JSON.parse(document.getElementById("tag_info").value);
                var just_tags = [];
                for (tag in user_tags) {

                    just_tags.push(user_tags[tag]['tag']);

                    var tag_string = user_tags[tag]['tag'];
                    var id = 'id_' + tag_string;

                    var $button_toggle = '<div class="btn btn-success tag-button" data-toggle="tooltip" data-placement="right" title="Remove this Tag" data-original-title="Remove this Tag"'
                            + 'id="' + id +
                            '" name="' + tag_string +'">'  + tag_string + '</div>';

                    var button_toggle_component = $($button_toggle).click(function(){
                        $(this).remove();
                    }).tooltip();

                    $("#final_tags").append(button_toggle_component);

                }

                alert('submit pressed ' + just_tags);

                $('#finish_tagging_dialog_form').dialog("open");

                {#            $('#image-taggin-form').submit(event);#}
            });




        });

        $('#image-taggin-form').bind("keyup keypress", function(e) {
            var code = e.keyCode || e.which;
            if (code  == 13) {
                e.preventDefault();
                return false;
            }
        });

        get_similar_images({{ image_id }});

        $('#question-accordion-prev').click(function(){

            if (current_question_pane - 1 > 0){
                var current_div = '#question_number_' + current_question_pane;
                $(current_div).hide('slide', 500, function(){

                    current_question_pane -= 1;
                    $('#question_number_' + current_question_pane).show('blind', 500, tidy_masonry());
                });
            }

        });

        $('#question-accordion-next').click(function(){
            if (current_question_pane + 1 < 5){
                var div_name = '#question_number_' + current_question_pane;

                $(div_name).hide('slide', 500, function(){

                    current_question_pane += 1;
                    $('#question_number_' + current_question_pane).show('blind', 500, tidy_masonry());
                });
            }
        });

        {#        $('#question_number_1').hide();#}
        $('#question_number_2').hide();
        $('#question_number_3').hide();
        $('#question_number_4').hide();
        $('#question_number_5').hide();



        $('.js-masonry').masonry();

        $('#collapse_cloud').accordion({
            active: false,
            collapsible: true,
            heightStyle: "content"

        });

        $('#collapse_metadata').accordion({
            active: false,
            collapsible: true,
            heightStyle: "content"
        });

        $('#collapse_descriptions').accordion({
            {% if image_descriptions|length > 0 %}
                active: 0,
            {% else %}
                active: false,
            {% endif %}
            collapsible: true,
            heightStyle: "content"
        });

        $('#collapse_similars').accordion({
            active: 0,
            collapsible: true,
            heightStyle: "content"

        });

        $('#collapse_machine_matched').accordion({
            active: 0,
            collapsible: true,
            heightStyle: "content"

        });

        $('#collapse_book_images').accordion({
            active: 0,
            collapsible: true,
            heightStyle: "content"

        });

        var tags = '';
        var the_tags = {{ image_tags|safe }};

        for (var tag in the_tags) {
            tags += '<div id="search_tag" class="btn btn-success search_tag" ' +
                    'data-val="' + the_tags[tag]['uses'] + '" ' +
                    'data-term="' + the_tags[tag]['tag'] + '" ' +
                    'style="margin: 5px; display: inline-block; font-size: '
                    + (font_size/2 + (the_tags[tag]['uses'] * (font_size/2))) + 'px;';
            if (the_tags[tag].hasOwnProperty('from_flickr')){
                tags += ' border-style: double; border: groove';
            }
            tags += '">' + the_tags[tag]['tag'] + '</div>';
        }

        $('#tag_cloud').html(tags);

        $('.search_tag').click(function(){
            var word = $(this).data('term');
            var link = "{% url 'do_advanced_search' %}" + '?keyword=' + word;
            window.open(link, '_blank');
        });


        $( "#dictionary" ).autocomplete({
            source: "{% url 'find.word' %}",
            minLength: 3,
            select: function( event, ui ) {
                {#                console.log( ui.item ?#}
                {#                        "Selected: " + ui.item.value + " aka " + ui.item.id :#}
                {#                        "Nothing selected, input was " + this.value );#}

                var tag_string = ui.item.value;
                var id = 'id_' + tag_string;
                var synset = ui.item.synset;

                {#                var $check = $('<input/>').attr({type: 'checkbox', id: id, checked: true, name: tag_string, x_percent: hightlighted_x_percent, y_percent: hightlighted_y_percent});#}
                {#                var $label = $('<label/>').attr({for: id}).html(tag_string);#}

                add_tag_button(tag_string, synset);

                {#                var $button_toggle = '<div class="btn btn-success tag-button" data-toggle="tooltip" data-placement="right" title="Remove this Tag" data-original-title="Remove this Tag"'#}
                {#                        + 'id="' + id +#}
                {#                        '" name="' + tag_string +#}
                {#                        '" x_percent="' + hightlighted_x_percent +#}
                {#                        '" y_percent="' + hightlighted_y_percent + '">' + tag_string + '</div>';#}
                {##}
                {##}
                {#                var d = new Date();#}
                {#                var datetime = d.toISOString();#}
                {#                all_tags.push({tag: tag_string,#}
                {#                    synset: synset,#}
                {#                    x_percent: hightlighted_x_percent,#}
                {#                    y_percent: hightlighted_y_percent,#}
                {#                    x_pixel: highlighted_x_pixel,#}
                {#                    y_pixel: highlighted_y_pixel,#}
                {#                    datetime: datetime,#}
                {#                    tag_order: all_tags.length#}
                {#                });#}
                {##}
                {##}
                {##}
                {#                document.getElementById("tag_info").value = JSON.stringify(all_tags);#}
                {#                console.log(JSON.parse(document.getElementById("tag_info").value));#}
                {##}
                {#                $("#add_tags_body").prepend($label).prepend($check);#}
                {##}
                {#                var button_toggle_component = $($button_toggle).click(function(){#}
                {#                    $(this).remove();#}
                {#                }).tooltip();#}
                {##}
                {#                $("#add_tags_body").append(button_toggle_component);#}

                ui.item.value = "";
            }
        }).keypress(function(e) {
            {#            if (image_clicked()) {#}
            {#                if(e.which == 13) {#}
            {#                    alert('You pressed enter!');#}
            {#                    return false;#}
            {#                }#}
            {#            }#}
            return true;
        }).focus(function(e){
            {#            image_clicked()#}
        }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
            return $( "<li>" )
                    .append( "<a><strong>" + item.label + "</strong><br>" + item.desc + "</a>" )
                    .appendTo( ul );
        };

        {#        function image_clicked(){#}
        {#            if(hightlighted_x_percent == 0#}
        {#                    && hightlighted_y_percent == 0#}
        {#                    && highlighted_x_pixel == 0#}
        {#                    && highlighted_y_pixel == 0) {#}
        {##}
        {#                var focus_message = '<div class="alert alert-dismissable alert-warning">\#}
        {#  <button type="button" class="close" data-dismiss="alert">×</button>\#}
        {#  Please try clicking part of the image before tagging objects.</div>'#}
        {#                $('#focus_alerts').html(focus_message).fadeIn(100);#}
        {#            } else {#}
        {#                $('#focus_alerts').fadeOut(1000);#}
        {#            }#}
        {#        }#}

        $('#load_new_image').click(function(){
            window.location.replace('{% url 'image.random' %}');
        });


        var finish_tagging_dialog_form = $( "#finish_tagging_dialog_form" ).dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "Save Image": function() {

                    finish_tagging_dialog_form.dialog( "close" );
                    $('#image-taggin-form').submit();

                },
                Cancel: function() {
                    finish_tagging_dialog_form.dialog( "close" );
                }
            },
            open : function() {

            },
            close: function() {

            }
        });


        var save_image_dialog_form = $( "#save_image_dialog_form" ).dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "Save Image": function() {

                    var e = document.getElementById("user_collection_select");
                    var collection_id = e.options[e.selectedIndex].value;

                    {#                    console.log({{ image_id }} + ' ' + collection_id);#}

                    if (collection_id == "NEW COLLECTION"){
                        save_image_dialog_form.dialog("close");
                        dialog.dialog("open");

                    } else {
                        saveImageToCollection(collection_id, {{ image_id }});
                    }

                    save_image_dialog_form.dialog( "close" );
                },
                Cancel: function() {
                    save_image_dialog_form.dialog( "close" );
                }
            },
            open : function() {
                var name = $(this).data('name');
                var id = $(this).data('id');
                $('#edit_image_caption_field').val(name);
            },
            close: function() {
                {#                form[ 0 ].reset();#}
                {#                allFields.removeClass( "ui-state-error" );#}
            }
        });


        function get_alt_tags(callback) {
            $.ajax({
                type: "POST",
                url: "{% url 'image.alt_tags' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    tag_info: document.getElementById("tag_info").value
                },
                success: function(data) {
                    var ok = data['success'];
                    console.log(data);
                    callback(data);
                    {#                    alert("Saved success : " + ok);#}

                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log("Problem with category: "+errorThrown+xhr.status+xhr.responseText);
                    callback(null);
                }
            });
        }




        function saveMapPoints(ney, nex, swy, swx) {
            $.ajax({
                type: "POST",
                url: "{% url 'image.coords_save' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    image_id: {{ image_id }},
                    north_east_y: ney,
                    north_east_x: nex,
                    south_west_y: swy,
                    south_west_x: swx
                },
                success: function(data) {
                    var ok = data['success'];
                    {#                    alert("Saved success : " + ok);#}

                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log("Problem with category: "+errorThrown+xhr.status+xhr.responseText);
                }
            });
        }


        $('#map-canvas').height($(window).height());

        var window_height = $(window).height();
        var window_width = $(window).width();

        var mapping_dialog_form = $( "#mapping_dialog_form" ).dialog({
            autoOpen: false,
            height: window_height - $('#navbar-main').height() - 40,
            width: window_width - 20,
            modal: true,
            buttons: {
                "Save Map": function() {

                    var ney =  document.getElementById("north_east_y").value;
                    var nex = document.getElementById("north_east_x").value;
                    var swy = document.getElementById("south_west_y").value;
                    var swx = document.getElementById("south_west_x").value;

                    saveMapPoints(ney, nex, swy, swx);

                    mapping_dialog_form.dialog( "close" );
                },
                Cancel: function() {
                    mapping_dialog_form.dialog( "close" );
                }
            },
            open : function() {
                {#                        $('#mapping_dialog_form').height($(window).height());#}

                var name = $(this).data('name');
                var id = $(this).data('id');


                // Note: This example requires that you consent to location sharing when
                // prompted by your browser. If you see a blank space instead of the map, this
                // is probably because you have denied permission for location sharing.

                var map;

                function initialize() {
                    var x =  document.getElementById("x").value;
                    var y =  document.getElementById("y").value;

                    var ney =  document.getElementById("north_east_y").value;
                    var nex = document.getElementById("north_east_x").value;
                    var swy = document.getElementById("south_west_y").value;
                    var swx = document.getElementById("south_west_x").value;

                    var mapOptions = {
                        center: new google.maps.LatLng(y, x),
                        zoom: 6
                    };
                    map = new google.maps.Map(document.getElementById('map-canvas'),
                            mapOptions);

                    var bounds = new google.maps.LatLngBounds(
                            new google.maps.LatLng(swy, swx),
                            new google.maps.LatLng(ney, nex)
                    );

                    // Define the rectangle and set its editable property to true.
                    rectangle = new google.maps.Rectangle({
                        bounds: bounds,
                        editable: true,
                        draggable: true
                    });

                    rectangle.setMap(map);

                    map.fitBounds(bounds);

                    // Add an event listener on the rectangle.
                    google.maps.event.addListener(rectangle, 'bounds_changed', showNewRect);

                    // Define an info window on the map.
                    infoWindow = new google.maps.InfoWindow();

                    // Try HTML5 geolocation
                    if(navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function(position) {
                            var pos = new google.maps.LatLng(position.coords.latitude,
                                    position.coords.longitude);

                            console.log(pos);
                            var infowindow = new google.maps.InfoWindow({
                                map: map,
                                position: pos,
                                content: 'Location found using HTML5.'
                            });

                            map.setCenter(pos);
                        }, function() {
                            handleNoGeolocation(true);
                        });
                    } else {
                        // Browser doesn't support Geolocation
                        handleNoGeolocation(false);
                    }
                }

                // Show the new coordinates for the rectangle in an info window.

                /** @this {google.maps.Rectangle} */
                function showNewRect(event) {
                    var ne = rectangle.getBounds().getNorthEast();
                    var sw = rectangle.getBounds().getSouthWest();

                    var contentString = '<b>Rectangle moved.</b><br>' +
                            'New north-east corner: ' + ne.lat() + ', ' + ne.lng() + '<br>' +
                            'New south-west corner: ' + sw.lat() + ', ' + sw.lng();

                    // Set the info window's content and position.
                    infoWindow.setContent(contentString);
                    infoWindow.setPosition(ne);


                    document.getElementById("north_east_y").value = ne.lat();
                    document.getElementById("north_east_x").value = ne.lng();
                    document.getElementById("south_west_y").value = sw.lat();
                    document.getElementById("south_west_x").value = sw.lng();

                }

                function handleNoGeolocation(errorFlag) {
                    if (errorFlag) {
                        var content = 'Error: Your browser denied Geolocation.';
                    } else {
                        var content = 'Error: Your browser doesn\'t support geolocation.';
                    }

                    var x =  document.getElementById("x").value;
                    var y =  document.getElementById("y").value;

                    var options = {
                        map: map,
                        position: new google.maps.LatLng(y, x),
                        content: content
                    };

                    map.setCenter(options.position);
                }

                {#                google.maps.event.addDomListener(window, 'load', initialize);#}
                initialize();


            },
            close: function() {
                populate_categories(0, null, null);
                $('#category-extra').empty();
            }
        });


        function saveImageToCollection(collection_name) {
            $.ajax({
                type: "POST",
                url: "{% url 'user_profile.new_collection' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    collection_name: collection_name,
                    image_id: {{ image_id }}
                },
                success: function(data) {
                    var ok = data['success'];
                    alert("Added Image to Favourites : " + collection_name);

                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log("Problem with category: "+errorThrown+xhr.status+xhr.responseText);
                }
            });
        }

        function addCollection(){
            var collection_name = $( "#collection_name").val();
            saveImageToCollection(collection_name);
            dialog.dialog( "close" );
        }

        var dialog = $( "#dialog-form" ).dialog({
            autoOpen: false,
            height: 300,
            width: 350,
            modal: true,
            buttons: {
                "Create a collection": addCollection,
                Cancel: function() {
                    dialog.dialog( "close" );
                }
            },
            close: function() {
                {#                form[ 0 ].reset();#}
                {#                allFields.removeClass( "ui-state-error" );#}
            }
        });

        $('.save_image_btn').each(function(){
            $(this).click(function() {
                $('#save_image_dialog_form').dialog("open");
            })
        });

        $('#map_btn').click(function() {
            $('#mapping_dialog_form').dialog("open");
        });

        function populate_categories(cat_id, callback, text) {
            $.ajax({
                type: "POST",
                url: "{% url 'image.category' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    category_id: cat_id,
                    text_entry: text,
                    image_id: {{ image_id }}
                },
                success: function(data) {

                    {#                    Clear the category container, ready to put new category buttons in #}
                    var category_container = $('#category-container');
                    var masonry_container = category_container.masonry();
                    masonry_container.masonry( 'remove', masonry_container.find('.category-answer'));
                    var category_extra_div = $('#category-extra').empty();

                    {#                    Get the question for this set of category buttons #}
                    var question = data['question'];
                    $('#category-question').html(question);

                    for (var ans in data['answers']) {

                        var classname = 'category-answer';
                        if (data['answers'][ans].text.length > 5) {
                            classname = 'category-answer wide';
                        }

                        var answer = '<div class="' + classname + '" ' +
                                'data-category_name="' + data['answers'][ans].name + '" ' +
                                'data-category_synset="' + data['answers'][ans].synset + '" ' +
                                'data-category_save="' + data['answers'][ans].save + '" ' +
                                'data-category_id="' + data['answers'][ans].id + '"> \
                            <div class="panel">\
                                <div class="category-answer-image">\
                                    <img src="' + data['answers'][ans].img + '"\
                                         style="width:100%; height: auto;\
                                         margin:0 auto; display:block; border:1px">\
                                </div>';
                        if (data['answers'][ans].text != ''){
                            answer +=    '<div class="panel-footer">\
                                    <div class="wrap-text">\
                                        ' + data['answers'][ans].text + '\
                                    </div>\
                                </div>';
                        }
                        answer += '</div>\
                        </div>';

                        var elem = $(answer);
                        masonry_container.append(elem).masonry( 'appended', elem );
                    }


                    for (var ans in data['actions']) {

                        var classname = 'category-answer';
                        if (data['actions'][ans].text.length > 5) {
                            classname = 'category-answer wide';
                        }

                        var answer = '<div class="' + classname + '" data-link="' + data['actions'][ans].link +
                                '" data-action_name="' + data['actions'][ans].action +
                                '" data-type="' + data['actions'][ans].type +
                                '" data-category_id="' + data['actions'][ans].id + '"> \
                            <div class="panel">\
                                <div class="category-answer-image">\
                                    <img src="' + data['actions'][ans].img + '"\
                                         style="width:100%; height: auto;\
                                         margin:0 auto; display:block; border:1px">\
                                </div>\
                                <div class="panel-footer">\
                                    <div class="wrap-text">\
                                        ' + data['actions'][ans].text + '\
                                    </div>\
                                </div>\
                            </div>\
                        </div>';

                        var action_elem = $(answer);
                        masonry_container.append(action_elem).masonry( 'appended', action_elem );

                        if (data['actions'][ans].type == 'text_entry') {
                            var text_input = '<label class="control-label" for="' + data['actions'][ans].action + '">'
                                    + data['actions'][ans].question +
                                    '</label><input class="form-control" id="' + data['actions'][ans].action + '">';

                            var text_input_elem = $(text_input);
                            category_extra_div.append(text_input_elem);

                            setTimeout("$('.form-control').focus()", 500);
                        }
                    }
                    enable_category_click();
                    setInterval("$('#category-container').masonry()", 500);
                    category_container.masonry();
                },
                error: function(xhr, textStatus, errorThrown) {
                    console.log("Problem with category: "+errorThrown+xhr.status+xhr.responseText);
                }
            });
            if (callback != null) {
                callback();
            }
        }

        function enable_category_click() {
            $('.category-answer').click(function() {
                var masonry_container = $('#category-container').masonry();
                masonry_container.masonry( 'remove', masonry_container.find('.category-answer'));

                if ($(this).data('action_name') == 'gazetteer') {
                    var cat_id = $(this).data('category_id');
                    var map_link = $(this).data('link');

                    {#                    console.log('clicked a request to show gazetteer');#}

                    var places_autocomplete = '<label class="control-label" for="places">Location: </label> \
                    <input class="form-control" id="places">'

                    var elem = $(places_autocomplete);
                    var category_extra_div = $('#category-extra');
                    category_extra_div.append(elem).on('focus', '.form-control', function() {

                        $( "#places" ).autocomplete({
                            source: function(request, response) {
                                $.ajax({
                                    type: 'GET',
                                    url: "http://unlock.edina.ac.uk/ws/nameSearch",
                                    dataType: "json",
                                    data: {
                                        name : request.term,
                                        format: "json",
                                        maxRows: 15
                                        {#                                    data_object : "publisher"#}
                                    },
                                    success: function(data) {
                                        response(data.features);
                                    }
                                });
                            },
                            minLength: 3,
                            select: function( event, ui ) {

                                add_tag_button(ui.item.properties['name'], '');
                                add_tag_button(ui.item.properties['country'], '');

                                var x = ui.item.properties.centroid.split(', ')[0];
                                var y = ui.item.properties.centroid.split(', ')[1];
                                var nex = ui.item.bbox[0];
                                var ney = ui.item.bbox[1];
                                var swx = ui.item.bbox[2];
                                var swy = ui.item.bbox[3];

                                var map_link_string = map_link
                                        + '?x=' + x
                                        + '&y=' + y
                                        + '&nex=' + nex
                                        + '&ney=' + ney
                                        + '&swx=' + swx
                                        + '&swy=' + swy;

                                if (nex == swx) {
                                    nex = nex + 0.05;
                                    swx = swx - 0.05;
                                }
                                if (ney == swy) {
                                    ney = ney + 0.05;
                                    swy = swy - 0.05;
                                }

                                document.getElementById("x").value = x;
                                document.getElementById("y").value = y;
                                document.getElementById("north_east_y").value = ney;
                                document.getElementById("north_east_x").value = nex;
                                document.getElementById("south_west_y").value = swy;
                                document.getElementById("south_west_x").value = swx;

                                console.log(map_link_string);

                                {#                                var win = window.open( map_link_string, '_blank');#}
                                {#                                if(win){#}
                                {#                                    //Browser has allowed it to be opened#}
                                {#                                    win.focus();#}
                                {#                                }else{#}
                                {#                                    //Broswer has blocked it#}
                                {#                                    alert('Please allow popups for this site');#}
                                {#                                }#}

                                $('#mapping_dialog_form').data('x', x).data('y', y).data('nex', nex).data('ney', ney).data('swx', swx).data('swy', swy).dialog("open");

                                populate_categories(cat_id, null, null);
                                category_extra_div.empty();

                            }
                        }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
                            return $( "<li>" )
                                    .append( "<a><strong>" + item.properties.name + " - " + item.properties.country +
                                            "</strong><br>" + item.properties.featuretype
                                            + "<br>" + item.properties.centroid + "</a>" )
                                    .appendTo( ul );
                        };
                    });

                    setTimeout("$('.form-control').focus()", 500);
                }

                else if ($(this).data('type') == 'text_entry') {
                    var cat_id = $(this).data('category_id');
                    var input_box = $('#' + $(this).data('action_name'));
                    console.log(input_box);
                    populate_categories(cat_id, null, input_box.val());

                    alert(input_box.val() + ' ' + cat_id);
                }

                        {#                else if ($(this).data('link')) {#}
                        {#                    var win = window.open($(this).data('link'), '_blank');#}
                        {#                    if(win){#}
                        {#                        //Browser has allowed it to be opened#}
                        {#                        win.focus();#}
                        {#                    }else{#}
                        {#                        //Broswer has blocked it#}
                        {#                        alert('Please allow popups for this site');#}
                        {#                    }#}
                        {#                    var cat_id = $(this).data('category_id');#}
                        {#                    populate_categories(cat_id, null, null);#}
                        {#                }#}
                else if ($(this).data('action_name') == 'map') {
                    $('#mapping_dialog_form').dialog("open");
                }
                else {
                    {#                    console.log($(this).data('category_save'));#}
                    if ($(this).data('category_save') == true) {
                        add_tag_button($(this).data('category_name'), $(this).data('category_synset'));
                    }
                    var cat_id = $(this).data('category_id');
                    populate_categories(cat_id, null, null);
                }
            });
        }

        populate_categories(0, enable_category_click, null);

        $('#add_tag').click(function(){

            var input_field = $("#input_tag");
            var tag_string = input_field.val();
            if (tag_string != "") {
                var id = 'id_' + tag_string;

                {#                var $check = $('<input/>').attr({type: 'checkbox', id: id, checked: true, name: tag_string});#}
                {#                var $label = $('<label/>').attr({for: id}).html(tag_string);#}
                {##}
                {#                $( "input[type=checkbox]" )#}
                {#                        .button();#}
            }
            input_field.val("");
        });



        var active = true;

        $('#collapse-init').click(function () {
            if (active) {
                active = false;
                $('.panel-collapse').collapse('show');
                $('.panel-title').attr('data-toggle', '');
                $(this).text('-');
            } else {
                active = true;
                $('.panel-collapse').collapse('hide');
                $('.panel-title').attr('data-toggle', 'collapse');
                $(this).text('+');
            }
        });

        $('#accordion').on('show.bs.collapse', function () {
            if (active) $('#accordion .in').collapse('hide');

        }).on('shown.bs.collapse', function () {
            $('.js-masonry').masonry();

        }).bind('accordionchange', function(event, ui) {
            console.log('change scroll to ' + ui.newHeader.offset.top)
            /* In here, ui.newHeader = the newly active header as a jQ object
             ui.newContent = the newly active content area */
            {#            $.scrollTo( ui.newHeader ); // or ui.newContent, if you prefer#}
            $('html,body').animate({scrollTop: ui.newHeader.offset().top},'slow');
        });

        function scrollToAnchor(aid){
            var aTag = $("a[name='"+ aid +"']");
            $('html,body').animate({scrollTop: aTag.offset().top},'slow');
        }

        {#        <a style="display: block" data-toggle="collapse" data-parent="#accordion" href="#collapseOne">#}

        var canvas_object = $('#photo'),
                canvas = canvas_object.get(0),
                ctx = canvas.getContext('2d'),
                parent = canvas_object.parent(),
                img = new Image;

        {#        function getMousePos(canvas, evt) {#}
        {#            var rect = canvas.getBoundingClientRect();#}
        {#            return {#}
        {#                x: evt.clientX - rect.left,#}
        {#                y: evt.clientY - rect.top#}
        {#            };#}
        {#        };#}
        {##}
        {#        function translateCoords(mouseX, mouseY, component, degreesRotation) {#}
        {#            var centerpointX = (component.getBoundingClientRect().width /2);#}
        {#            var centerpointY = (component.getBoundingClientRect().height /2);#}
        {##}
        {#            var mouseOffsetX = mouseX - centerpointX;#}
        {#            var mouseOffsetY = mouseY - centerpointY;#}
        {##}
        {#            var radians = ((degreesRotation) * (Math.PI/180));#}
        {##}
        {#            var theta = Math.atan(mouseOffsetY / mouseOffsetX);#}
        {##}
        {#            var hyp = mouseOffsetX / Math.cos(theta);#}
        {##}
        {#            var scale = 1;#}
        {##}
        {#            if (Math.cos(radians) == 0) {#}
        {#                scale = img.naturalWidth / canvas.height;#}
        {#            } else {#}
        {#                scale = img.naturalWidth / canvas.width;#}
        {#            }#}
        {##}
        {#            var draw_x = (hyp * Math.cos(theta - radians)) + centerpointX;#}
        {##}
        {#            var draw_y = (hyp * Math.sin(theta - radians)) + centerpointY;#}
        {##}
        {#            return {#}
        {#                radians: radians,#}
        {#                theta: theta,#}
        {#                hyp: hyp,#}
        {#                x : draw_x,#}
        {#                y : draw_y,#}
        {#                offsetX : mouseOffsetX,#}
        {#                offsetY : mouseOffsetY,#}
        {#                centerpointX : centerpointX,#}
        {#                centerpointY :  centerpointY,#}
        {#                x_percent : (((draw_x/img.naturalWidth)*scale) *100),#}
        {#                y_percent : (((draw_y/img.naturalHeight)*scale) *100)#}
        {#            }#}
        {#        };#}

        {#        canvas.addEventListener('mousemove', function(evt) {#}
        {#            var mousePos = getMousePos(canvas, evt);#}
        {#            var translated_variables = translateCoords(mousePos.x, mousePos.y, canvas, degs);#}
        {##}
        {#            var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;#}
        {#            message += ('<br>draw coords: ' + translated_variables.x + ' , ' + translated_variables.y);#}
        {#            message += ('<br>scale-x% : ' + translated_variables.x_percent + ', scale-y% ' + translated_variables.y_percent);#}
        {##}
        {#            message += ('<br>offset : ' + translated_variables.offsetX + ' , ' + translated_variables.offsetY);#}
        {#            message += ('<br>centerpoint : ' + translated_variables.centerpointX + ' , ' + translated_variables.centerpointY);#}
        {#            message += ('<br>theta : ' + translated_variables.theta + ', hyp : ' + translated_variables.hyp);#}
        {#            message += ('<br>degs : ' + degs + ', rads : ' + translated_variables.radians);#}
        {#            message += ('<br>t-x : ' + (mousePos.x / translated_variables.x) + ', t-y : ' + (mousePos.y / translated_variables.y));#}
        {##}
        {#            $('#output').html(message);#}
        {#        }, false);#}

        img.src = "{{ image.imageurl }}";
        img.onload = function(){

            var windowHeight = $(window).height() * 0.8;
            var maxWindowWidth = $(window).width() * (6/12);

            var scale = img.naturalHeight / windowHeight;
            canvas.width = img.naturalWidth / scale;
            canvas.height = windowHeight;

            console.log('nat:' + img.naturalHeight + ' window:' + windowHeight + ' scale:' + scale);


            var jumbotronWidth = canvas.width + 200;
            if (jumbotronWidth > maxWindowWidth){
                var widthScale = jumbotronWidth / maxWindowWidth ;
                canvas.width = canvas.width / widthScale;
                canvas.height = canvas.height / widthScale;
            }
            console.log('jmbo:' + jumbotronWidth + ' window:' + maxWindowWidth + ' scale:' + widthScale);

            ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);

            $(".photo_background").height(windowHeight).css({'width': canvas.width, 'margin': '0 auto'});

            $(".photo-jumbotron").css({'margin': '0 auto', 'width': canvas.width + 80});


            {#            var divSizes = getPhotoDivSizes(img.naturalWidth, img.naturalHeight);#}
            {##}
            {#            ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, divSizes['width'], divSizes['height']);#}
            {##}
            {#            $(".photo-jumbotron").css({'margin': '0 auto', 'width': divSizes['width'] + 80});#}
            {#            $(".photo_background").height(divSizes['height']).css({'width': divSizes['width'], 'margin': '0 auto'});#}


        };

        function getPhotoDivSizes(apparentWidth, apparentHeight) {
            var windowHeight = $(window).height() * 0.8;
            var maxWindowWidth = $(window).width() * (6/12);

            var scale = apparentHeight / windowHeight;
            var fitWidth = apparentWidth / scale;
            var fitHeight = windowHeight;

            console.log('nat:' + apparentHeight + ' window:' + windowHeight + ' scale:' + scale);

            var jumbotronWidth = fitWidth + 200;
            if (jumbotronWidth > maxWindowWidth){
                var widthScale = jumbotronWidth / maxWindowWidth ;
                fitWidth = fitWidth / widthScale;
                fitHeight = fitHeight / widthScale;
            }
            console.log(maxWindowWidth + ' ' + jumbotronWidth + ' ' + widthScale);


            return {
                'width': fitWidth,
                'height': fitHeight
            };

        }

        var degs = 0;
        var r = $("#photo").get(0).getBoundingClientRect();

        $(".rota").click(function() {
            var photo = $("#photo");
            var turn_degs = $(this).data('degs');

            if (turn_degs == 'reset') {
                degs = 0;
            } else {
                degs += turn_degs;
                if (degs < 0) {
                    degs += 360;
                }
            }

            console.log(photo.width());

            photo.rotate( {animateTo: degs}, 'abs' );

            degs = degs%360;

            console.log(getRotatedSize(degs, photo.width(), photo.height()));

            var offset_top = photo.offset().top;

            var offset_l = photo.offset().left;

            var apparentDimentions = getRotatedSize(degs, photo.width(), photo.height());

            var divSizes = getPhotoDivSizes(apparentDimentions['width'], apparentDimentions['height']);

            $(".photo-jumbotron").height($(window).height() * 0.8).css({'margin': '0 auto', 'width': divSizes['width'] + 80});
            $(".photo_background").height(divSizes['height']).css({'width': divSizes['width'], 'margin': '0 auto'});

            if (photo.width() < apparentDimentions['width']) {
                var horizontalOffset = (apparentDimentions['width'] - photo.width()) / 2;

                photo.css({'margin-left': horizontalOffset});
            } else {
                photo.css({'margin-left': 0});

            }

            load_css();
        });

        function getRotatedSize(angle, originalWidth, originalHeight) {
            var rads = angle * Math.PI / 180;
            var cosA = Math.cos(rads);
            var sinA = Math.sin(rads);

            var rotatedWidth = Math.round(originalWidth * Math.abs(cosA) + originalHeight * Math.abs(sinA));
            var rotatedHeight = Math.round(originalWidth * Math.abs(sinA) + originalHeight * Math.abs(cosA));

            return { 'width': rotatedWidth, 'height': rotatedHeight };
        }


        {#        var hightlighted_x_percent = 0;#}
        {#        var hightlighted_y_percent = 0;#}
        {#        var highlighted_x_pixel = 0;#}
        {#        var highlighted_y_pixel = 0;#}

        $('#side-menu-open').click(function(){
            $('.side-menu-content-wide').show('slide', 100);
            $('.side-menu-content-thin').hide();

        });
        $('#side-menu-close').click(function(){
            $('.side-menu-content-wide').hide('slide', 100, function(){
                $('.side-menu-content-thin').show();
            });

        });

        $('.side-menu-content-wide').hide();
        $( "#dictionary").focus();

    });


    </script>


    <div class="side-menu">
        {% url 'page_turner' book_id=book_id page=page volume=volume as page_turner_url  %}

        <div class="side-menu-content-thin">

            <ul class="side-menu-list">
                {#                <li>#}
                {#                    <div class="side-menu-content-thin-header">#}
                {#                        <ul class="side-menu-list">#}
                {#                            <li>#}
                {#                                <div id="side-menu-open" class="btn btn-success side-menu-btn"><div class="fa fa-wrench"></div></div>#}
                {#                            </li>#}
                {#                        </ul>#}
                {#                    </div>#}
                {#                </li>#}
                <li>
                    <div class="side-menu-content-thin-body">
                        <ul class="side-menu-list">
                            <li>
                                <a data-toggle="tooltip" data-placement="top"
                                   title="Rotate illustration left" data-original-title="Rotate Left"
                                   class="rota btn btn-success side-menu-btn" data-degs="-90"><div class="fa fa-rotate-left"></div></a>
                            </li>
                            <li>
                                <a data-toggle="tooltip" data-placement="top"
                                   title="Rotate illustration right" data-original-title="Rotate Right"
                                   class="rota btn btn-success side-menu-btn" data-degs="90"><div class="fa fa-rotate-right"></div></a>
                            </li>
                            <li data-toggle="tooltip" data-placement="top"
                                title="Zoom Illustration" data-original-title="Zoom">
                                <a class="btn btn-success side-menu-btn" data-toggle="modal" data-target=".bs-example-modal-lg">
                                    <div class="fa fa-search-plus"></div></a>
                            </li>
                            <li>
                                <a data-toggle="tooltip" data-placement="top"
                                   title="View the page this illustration came from" data-original-title="Full Page"
                                   class="btn btn-success side-menu-btn" target="_blank"
                                   href="{{ page_turner_url }}"
                                        ><div class="fa fa-book"></div></a>
                            </li>
                            <li>
                                <a data-toggle="tooltip" data-placement="top"
                                   title="Download illustration" data-original-title="Download"
                                   class="btn btn-success side-menu-btn" target="_blank"
                                   href="{{ image.imageurl }}"><div class="fa fa-cloud-download"></div></a>
                            </li>
                            {% if user.is_authenticated %}
                                <li>
                                    <div data-toggle="tooltip" data-placement="top"
                                         title="Add illustration to Favourites" data-original-title="Save"
                                         class="btn btn-success side-menu-btn save_image_btn save_image"><div class="fa fa-heart"></div></div>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </li>
            </ul>
        </div>

        <div class="side-menu-content-wide">
            <ul class="side-menu-list">
                <li>
                    <div class="side-menu-content-wide-header">
                        <ul class="side-menu-list">
                            <li>
                                <div id="side-menu-close" class="btn btn-success"><div class="fa fa-2x fa-wrench"></div></div>
                            </li>
                        </ul>
                    </div>
                </li>
                <li>
                    <div class="side-menu-content-wide-body">
                        <ul class="side-menu-list">
                            <li class="previous">
                                <a class="rota btn btn-success side-menu-btn" data-degs="-90"><div class="fa fa-2x fa-rotate-left"></div></a>
                                <a class="rota btn btn-success side-menu-btn" data-degs="90"><div class="fa fa-2x fa-rotate-right"></div></a>
                            </li>
                            <li>
                                <a class="btn btn-success side-menu-btn" data-toggle="modal" data-target=".bs-example-modal-lg">
                                    <div class="fa fa-2x fa-search-plus"></div></a>
                            </li>
                            <li>
                                <a class="btn btn-success side-menu-btn" target="_blank"
                                   href="{{ page_turner_url }}"
                                        ><div class="fa fa-2x fa-book"></div></a>
                            </li>
                            <li>
                                <div style="margin-top: 5px">
                                    <a href="https://twitter.com/share" class="twitter-share-button" data-text="I'm tagging this image with the @Lost_Visions project" data-size="large" data-hashtags="Lost_Visions">Tweet</a>
                                    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
                                </div>
                            </li>
                            {% if user.is_authenticated %}
                                <li>
                                    <a class="btn btn-default save_image_btn save_image">
                                        <img src="{% static 'media/images/free-vector-heart-gloss-5_101629_Heart_Gloss_5.png' %}" style="max-height: 27px">
                                    </a>
                                </li>

                            {% endif %}
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    {#    <div class="container">#}
    <div class="row" style="margin: 0 auto; width: 90%">
        <div class="title-logo col-md-12">
            <img src="{% static "media/images/new_design/IllustrationArchive_FinalHeader_TagImages.png" %}" style="min-height: 53px"/>
        </div>
    </div>

    <div class="col-xs-12 col-sm-7">

    <div id="photo-jumbotron" class="jumbotron photo-jumbotron" data-step="1" data-intro="This is the image to be tagged." data-position="right">
        <div id="photo_background" class="photo_background">
            <canvas id='photo'></canvas>
            {#            src="{{ image.imageurl }}  style=' min-width:50px; min-height: 50px;width: 100%; height:auto; "#}
        </div>
    </div>

    {#    <div class="panel-footer">#}
    {#        <ul class="pager">#}
    {#            <li class="previous">#}
    {#                <a class="rota btn btn-default" data-degs="-90"><div class="fa fa-rotate-left"></div></a>#}
    {#            </li>#}
    {#            <li>#}
    {#                <a class="btn btn-default" data-toggle="modal" data-target=".bs-example-modal-lg">#}
    {#                    <div class="fa fa-search-plus"></div></a>#}
    {#            </li>#}
    {#            <li>#}
    {#                <a class="btn btn-default" target="_blank"#}
    {#                   href="{% url 'page_turner' book_id=book_id page=page volume=volume%}">Full Page</a>#}
    {#            </li>#}
    {#            <li class="next">#}
    {#                <a class="rota btn btn-default" data-degs="90"><div class="fa fa-rotate-right"></div></a>#}
    {#            </li>#}
    {#        </ul>#}
    {#                {% if user.is_authenticated %}#}
    {#                    <ul class="pager">#}
    {#                        <li>#}
    {#                            <select id="user_collection_select">#}
    {#                                {% for option in user_collections %}#}
    {#                                    <option id="{{ option }}" value="{{ option }}">#}
    {#                                        {{ option }}#}
    {#                                    </option>#}
    {#                                {% endfor %}#}
    {#                            </select>#}
    {#                        </li>#}
    {#                        <li>#}
    {#                            <a class="btn btn-default save_image" id="save_image">#}
    {#                                <img src="{% static 'media/images/free-vector-heart-gloss-5_101629_Heart_Gloss_5.png' %}" style="max-height: 27px">#}
    {#                            </a>#}
    {#                        </li>#}
    {#        #}
    {#                    </ul>#}
    {#                {% endif %}#}
    {##}
    {#        <ul  class="pager">#}
    {#            <li>#}
    {#                <a href="https://twitter.com/share" class="twitter-share-button" data-text="I'm tagging this image with the @Lost_Visions project" data-size="large" data-hashtags="Lost_Visions">Tweet</a>#}
    {#                <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>#}
    {#            </li>#}
    {#        </ul>#}
    {#        <div id="output"></div>#}
    {#    </div>#}

    {#    <div id="map_btn" class="btn btn-default">MAP STUFF</div>#}

    <div data-toggle="tooltip" data-placement="top"
         title="Tags previously added for this Illustration" data-original-title="Image Tags"
         id="collapse_cloud" class="panel-group"
         data-step="2" data-intro="This is the tag cloud for the Illustration.\n Previous Illustration taggers may have added the same tag as you, <br>which helps us raise it's relevance in search results"
         data-position="right">
        <div class="panel-heading">
            <h4 class="panel-title">
                Cloud of Tags
            </h4>
        </div>

        <div class="panel-body">
            <div id="tag_cloud" class="container-fluid" style="height: 200px; width:auto">
            </div>
        </div>
    </div>


    <div data-toggle="tooltip" data-placement="top"
         title="Information and Metadata for this Illustration" data-original-title="Image Metadata"
         id="collapse_metadata" class="panel-group"
         data-step="3" data-intro='This is the metadata for the Illustration' data-position="right">
        <div class="panel-heading">
            <h4 class="panel-title">
                Illustration Information and Metadata
            </h4>
        </div>
        <div class="panel-body">
            <div class="bs-example table-responsive">
                <table class="table table-striped table-hover ">
                    <tbody>
                    <tr><th>Permanent link</th><td><a href="{{ this_url }}" >{{ this_url }}</a></td></tr>
                    {#                        <tr><th>Download Image</th><td>#}
                    {#                            {% if image.arcca == True %}#}
                    {#                                <a href="{% static image.imageurl %}" target="_blank" download>Download</a><br>#}
                    {#                                <a href="{% static image.imageurl %}" target="_blank">New Tab</a>#}
                    {#                            {% else %}#}
                    {#                                <a href="{{ image.flickr_url }}" target="_blank">From Flickr</a><br>#}
                    {#                            {% endif %}#}
                    {##}
                    {#                        </td></tr>#}
                    {#                <tr>#}
                    {#                    <th>Full page</th>#}
                    {#                    <td><a target="_blank" href="{% url 'page_turner' book_id=book_id page=page volume=volume%}">Click here</a></td>#}
                    {#                </tr>#}
                    {% for mykey,value in formatted_info.items %}
                        {% if mykey == 'Title' %}
                            <tr><th>{{ mykey }}</th>
                                <td class="metadata-cell">
                                    <a href="{% url 'do_advanced_search' %}?book_id={{ book_id }}&csrfmiddlewaretoken={{ csrf_token }}" target="_blank">{{ value }}</a>
                                </td>
                            </tr>
                        {% elif mykey != 'tags' and mykey != 'Book ID' and mykey != 'Identifier'%}
                            <tr><th>{{ mykey }}</th><td class="metadata-cell">
                                {% if value == '' %}UNKNOWN{% else %}{{ value }}{% endif %}
                            </td></tr>
                        {% endif %}
                    {% endfor %}
                    </tbody>
                </table>
                {% for linked in linked_images %}
                    <div class="bs-example table-responsive">
                        <table class="table table-striped table-hover ">
                            <tbody>
                            {#                    <tr><th>Name</th><td>{{ linked.name }}</td></tr>#}
                            <tr><th>Preliminary Sketch</th><td><a href="{{ linked.link }}" target="_blank">{{ linked.name }}</a></td></tr>
                            <tr><th>Info</th><td>{{ linked.info }}</td></tr>
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
            </div>

        </div>
    </div>


    <div data-toggle="tooltip" data-placement="top"
         title="User Generated Descriptions" data-original-title="Descriptions"
         id="collapse_descriptions" class="panel-group"
         data-step="4" data-intro='These are user generated descriptions for the Illustration' data-position="right">
        <div class="panel-heading">
            <h4 class="panel-title">
                User Descriptions ({{ image_descriptions|length }})
            </h4>
        </div>

        <div class="panel-body">
            <div class="bs-example table-responsive">
                <table class="table table-striped table-hover ">
                    <div>
                        {% for desc in image_descriptions %}
                            <tr><td>
                                <div class="fa fa-quote-left" style="float: left"></div>
                                {{ desc }}
                                <div class="fa fa-quote-right" style="float: right"></div>
                            </td></tr>
                        {% endfor %}
                    </div>
                </table>
            </div>
        </div>
    </div>

    <div data-toggle="tooltip" data-placement="top"
         title="Similar Illustration" data-original-title="Similar Images"
         id="collapse_similars" class="panel-group"
         data-step="5" data-intro='These are potentially similar Illustration' data-position="right">
        <div class="panel-heading">
            <h4 class="panel-title">
                Similar Illustrations
            </h4>
        </div>
        <div id="similars" class="similar-images">
            <div style="margin: 0 auto; text-align: center; margin-top: 20px">
                <div class="fa fa-3x fa-spinner fa-spin"></div>
            </div>
        </div>
    </div>


    <div data-toggle="tooltip" data-placement="top"
         title="Machine Matched Images" data-original-title="Similar Images"
         id="collapse_machine_matched" class="panel-group"
         data-step="6" data-intro='These are potentially similar images' data-position="right">
        <div class="panel-heading">
            <h4 class="panel-title">
                Machine Matched Illustrations
            </h4>
        </div>
        <div id="machine_matched_images" class="similar-images">
            <div style="margin: 0 auto; text-align: center; margin-top: 20px">
                <div class="fa fa-3x fa-spinner fa-spin"></div>
            </div>
        </div>
    </div>

    <div data-toggle="tooltip" data-placement="top"
         title="Book Illustration" data-original-title="Book Illustrations"
         id="collapse_book_images" class="panel-group"
         data-step="6" data-intro='These are Illustration from this book' data-position="right">
        <div class="panel-heading">
            <h4 class="panel-title">
                Other Illustrations from this Book
            </h4>
        </div>
        <div id="book_images" class="similar-images">
            <div style="margin: 0 auto; text-align: center; margin-top: 20px">
                <div class="fa fa-3x fa-spinner fa-spin"></div>
            </div>
        </div>
    </div>


    </div><!--/span-->


    <div class="col-xs-12 col-sm-5">

        <div id="right-main">
            {% if user.is_authenticated %}

            {% else %}
                <div class="bs-component">
                    <div class="alert alert-dismissable alert-info">
                        <button type="button" class="close" data-dismiss="alert">×</button>
                        You are not logged in. You can do more if you sign up!
                    </div>
                    <div id="source-button" class="btn btn-primary btn-xs" style="display: none;">&lt; &gt;</div>
                </div>
            {% endif %}

            <form action="{% url 'image.tags' %}" id="image-taggin-form" method="post">{% csrf_token %}
                {{ tag_form.non_field_errors }}
                <input type="hidden" name="image_id" value="{{ image_id }}" />
                <input type="hidden" id = 'tag_info' name="tag_info" value="" />

                <div class="question-frame">
                    <div data-step="4" data-intro="These are the tagging options" data-position="left">
                        <div id="question_number_1" class="panel panel-default">
                            <div id="collapseOne">
                                <div class="panel-body question-panel">
                                    <h2>1/4</h2>
                                    <h3>Types of Illustration</h3>
                                    {#                                        <p>Is the illustration:</p>#}
                                    <div id="category-question">{{ category_data.question }}</div>
                                    <div id="add_category_body"></div>
                                    <div id="category-extra"></div>

                                    <div id="category-container" class="js-masonry"
                                         data-masonry-options='{"itemSelector": ".category-answer" }'>
                                        <div class="grid-sizer"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                    <div id="question_number_2" class="panel panel-default">
                        <div id="collapseTwo">
                            {#                                     data-toggle="tooltip" data-placement="top"#}
                            {#                                     title="Type a word which describes this image" data-original-title="Tag Box">#}
                            <div class="panel-body question-panel">
                                <h2>2/4</h2>
                                <h3>Objects and Ideas</h3>

                                <p>Are there any other things or ideas in this illustration?</p>
                                <p>For example:  "bird", "table", "winter", "love"</p>
                                <div id="focus_alerts"></div>
                                <div id="add_tags_body"></div>

                                <div class="ui-widget">
                                    <label class="'control-label" for="dictionary">Tags: </label>
                                    <input
                                            class="'form-control" id="dictionary">
                                </div>
                            </div>
                        </div>
                    </div>



                    <div id="question_number_3" class="panel panel-default">
                        <div>
                            <div class="panel-body question-panel">
                                <h2>3/4</h2>
                                <h3>Caption</h3>
                                <h4>If the Illustration has a caption, please transcribe it below:’</h4>
                                <div id="free_text_caption" >
                                    <label class="control-label" for="input_caption">Caption</label>
                                    <textarea class="form-control" rows="2" id="input_caption" name="input_caption"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>



                    <div id="question_number_4" class="panel panel-default">
                        <div id="collapseFive">
                            <div class="panel-body question-panel">
                                <h2>4/4</h2>
                                <h3>Description</h3>
                                <h4>‘If there is anything else you would like to tell us about this illustration,
                                    please enter it below:</h4>

                                <div id="free_text_description" class="row-fluid">
                                    <label class="'control-label" for="free-text-area">Description</label>
                                    <textarea name="image_description" class="form-control"
                                              rows="3" id="free-text-area"></textarea>
                                </div>

                                {#                                        <h4><a href="#">Or Discuss this Image on the Forum</a></h4>#}
                            </div>
                        </div>
                    </div>
                </div>


                <ul class="pager prev_next_pager">
                    <li style="float: left">
                        <div data-toggle="tooltip" data-placement="top"
                             title="Previous Question" data-original-title="Previous"
                             id="question-accordion-prev" class="btn btn-success"><div class="fa fa-2x fa-angle-double-left"></div> Back</div>
                    </li>
                    <li style="float: left">
                        <div data-toggle="tooltip" data-placement="top"
                             title="Next Question" data-original-title="Next"
                             id="question-accordion-next" class="btn btn-success">Next <div class="fa fa-2x fa-angle-double-right"></div></div>
                    </li>
                    <li style="float: right">
                        <div id="tagging-submit-btn" data-toggle="tooltip" data-placement="top"
                             title="Finish Tagging" data-original-title="Finish"
                                {#                                type="submit" #}
                             class="btn btn-success">Finish Tagging this Illustration<div class="fa fa-2x fa-check"></div>
                        </div>
                    </li>
                </ul>
                {#                    <button type="submit" class="btn btn-success"><div class="fa fa-2x fa-check"></div></button>#}
                <div class="navbar-right">
                    <div id="load_new_image" class="btn btn-success">
                        <a href="{% url 'image.random' %}">Skip this Illustration</a>
                    </div>
                </div>
            </form>
        </div>

    </div>

    {#    </div>#}
    {#end of main bootsrap container#}


    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <img id='zoom-photo' src="{{ image.flickr_original_source }}" style='width: auto; height:75%; margin: 0 auto'>
            </div>
        </div>
    </div>

    <div id="dialog-form" title="Create new collection">
        <p class="validateTips">Enter name of new Illustration collection</p>

        <form>
            <fieldset>
                <label for="collection_name">Name</label>
                <input type="text" name="collection_name" id="collection_name" value="" class="text ui-widget-content ui-corner-all">

                <!-- Allow form submission with keyboard without duplicating the dialog button -->
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>

    <div id="save_image_dialog_form" title="Save Image to Collecton">
        <p class="validateTips">Save Illustration to Collecton</p>
        <div id="save_image_data" data-collection_id="" data-collection_name=""></div>
        <form>
            <fieldset>
                <select id="user_collection_select">
                    {% for option in user_collections %}
                        <option id="{{ option }}" value="{{ option }}">
                            {{ option }}
                        </option>
                    {% endfor %}
                </select>
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>

    <div id="finish_tagging_dialog_form" title="Complete Illustration Tagging">
        <p class="validateTips">Please remove any incorrect tags then complete the illustration tagging</p>
        <div id="finish_tagging_data" data-collection_id="" data-collection_name=""></div>
        <form>
            <fieldset>
                <div id="final_tags"></div>
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>

    <div id="mapping_dialog_form" title="Map Illustration">
        {#        <p class="validateTips">Map Image</p>#}
        {#        <div id="save_image_data" data-collection_id="" data-collection_name=""></div>#}

        {#        <form action="{% url 'image.coords' image_id=image_id %}" id="image-map-form" method="post">{% csrf_token %}#}


        <input type="hidden" name="image_id" value="{{ image_id }}" />
        <input type="hidden" id = 'x' name="x" value="{{ x }}" />
        <input type="hidden" id = 'y' name="y" value="{{ y }}" />

        <input type="hidden" id = 'north_east_x' name="north_east_x" value="{{ ne_x }}" />
        <input type="hidden" id = 'north_east_y' name="north_east_y" value="{{ ne_y }}" />
        <input type="hidden" id = 'south_west_x' name="south_west_x" value="{{ sw_x }}" />
        <input type="hidden" id = 'south_west_y' name="south_west_y" value="{{ sw_y }}" />
        <div>
            {##}
            {#            <div class="jumbotron" style="height: auto; width: 100%">#}
            {#                <div class="panel-footer">#}
            {#                    <ul class="pager">#}
            {#                        <li>#}
            {#                            <button type="submit" class="rota btn btn-default">Save</button>#}
            {#                        </li>#}
            {#                    </ul>#}
            {#                </div>#}
            <div id="map-canvas" style="height: 100%; width: 100%"></div>
            {##}
            {#                <div class="panel-footer">#}
            {#                    <ul class="pager">#}
            {#                        <li>#}
            {#                            <button type="submit" class="rota btn btn-default">Save</button>#}
            {#                        </li>#}
            {#                    </ul>#}
            {#                </div>#}
            {#            </div>#}
            {#        </form>#}
        </div>
        <form>
            <fieldset>
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
            </fieldset>
        </form>
    </div>

{% endblock %}
