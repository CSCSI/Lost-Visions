{% extends "base.html" %}
{% load staticfiles %}


{% block content %}

    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">
    function load_new_image() {
        myApp.showPleaseWait()
        var name = 'test';
        Dajaxice.lost_visions.new_image(Dajax.process,{'name': name});
    }

    function change_image(url){
        {#            $('#photo').attr("src", url);#}
        location.reload();
        myApp.hidePleaseWait();
    }

    var myApp;
    myApp = myApp || (function () {
        var pleaseWaitDiv = $('<div class="modal hide" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false"><div class="modal-header"><h1>Processing...</h1></div><div class="modal-body"><div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div></div></div>');
        return {
            showPleaseWait: function() {
                pleaseWaitDiv.modal();
            },
            hidePleaseWait: function () {
                pleaseWaitDiv.modal('hide');
            }
        }
    })();

    {#        function register_tree_categories() {#}
    {#            $('#add_category').click(function(){#}
    {#                console.log(this);#}
    {##}
    {#                var input_field = $("#input_tag");#}
    {#                var tag_string = input_field.val();#}
    {#                if (tag_string != "") {#}
    {#                    var id = 'id_' + tag_string;#}
    {##}
    {#                    var $check = $('<input/>').attr({type: 'checkbox', id: id, checked: true, name: tag_string});#}
    {#                    var $label = $('<label/>').attr({for: id}).html(tag_string);#}
    {##}
    {##}
    {#                    $("#add_category_body").prepend($label).prepend($check);#}
    {##}
    {#                    $( "input[type=checkbox]" )#}
    {#                            .button();#}
    {#                }#}
    {#                input_field.val("");#}
    {#            });#}
    {#        }#}

    $(document).ready(function () {
        {#            $('#submit_button').click(function(){#}
        {#                Dajaxice.lost_visions.submit_tags(#}
        {#                        Dajax.process,{'form':$('#tags-form').serialize(true), 'image_id':'{{image_id}}'})#}
        {#            });#}
        {##}
        $('#load_new_image').click(function(){
            window.location.replace({% url 'image.random' %})
            {#                Dajaxice.lost_visions.load_image(Dajax.process,{})#}
        });

        $('#add_tag').click(function(){

            var input_field = $("#input_tag");
            var tag_string = input_field.val();
            if (tag_string != "") {
                var id = 'id_' + tag_string;

                var $check = $('<input/>').attr({type: 'checkbox', id: id, checked: true, name: tag_string});
                var $label = $('<label/>').attr({for: id}).html(tag_string);


                $("#add_tag_body").prepend($label).prepend($check);

                $( "input[type=checkbox]" )
                        .button();
            }
            input_field.val("");
        });

        var degs = 0;
        var r = $("#photo").get(0).getBoundingClientRect();
        console.log(r);

        $(".rota").click(function() {
console.log("click");
            var photo = $("#photo");
            var turn_degs = $(this).data('degs');

            if (turn_degs == 'reset') {
                degs = 0;
            } else {
                degs += turn_degs;

                if (degs < 0) {
                    degs += 360;
                }
            }

            photo.rotate( {animateTo: degs}, 'abs' );


            degs = degs%360;


            var offset_top = photo.offset().top;

            var offset_l = photo.offset().left;

            {#            offset_top -= r.top;#}
            {#            offset_l -= r.left;#}

            {#            lbl.html(angle + " <br>" + offset_top + " <br>" + offset_l + "<br>" + r.top+ " <br>" + r.left);#}

            {#            photo.css({marginTop: '-=' + offset_top + 'px'});#}

            {#            photo.css({marginLeft: '-=' + offset_l + 'px'});#}

            $("#rotval").html(degs + " degrees rotation" + "<br>" +
                    offset_top + "<br>" + offset_l + "<br>" + r.top+ "<br>" + r.left);


            load_css();

        });

        $('#photo').click(function(e) {
            var posX = $(this).offset().left, posY = $(this).offset().top;
            alert((e.pageX - posX)+ ' , ' + (e.pageY - posY));
        });

        $('#category_tree').bind("ready.jstree", function(){

        }).jstree({ 'core' : {
            'data' : dmvi_categories

        }
        }).on("changed.jstree", function (e, data) {

            var inst = data.instance;
            var i, j = [];
            for(i = 0, j = data.selected.length; i < j; i++) {

                if (inst.is_leaf(inst.get_node(data.selected[i]))) {

                    var tag_string = inst.get_node(data.selected[i]).text
                    var id = 'id_' + tag_string;

                    var $check = $('<input/>').attr({type: 'checkbox', id: id, checked: true, name: tag_string});
                    var $label = $('<label/>').attr({for: id}).html(tag_string);


                    $("#add_category_body").prepend($label).prepend($check);

                    $( "input[type=checkbox]" )
                            .button();
                } else {
                    inst.toggle_node(inst.get_node(data.selected[i]));
                }
            }

        });

        var availableTags = [];

        dmvi_categories.forEach(function(entry) {

            availableTags.push(entry['text']);

        });


        cascade_nodes = function(id){
            dmvi_categories.forEach(function(entry) {
                if(entry['id'] == id) {
                    $('#category_tree').jstree('open_node', entry['id']);
                    cascade_nodes(entry['parent'])
                }
            });
        };

        $( "#tags" ).autocomplete({
            source: availableTags,
            select: function( event, ui ) {
                $('#category_tree').jstree('close_all', -1);

                {#                    console.log( ui.item.label );#}
                {#                    console.log( ui.item.value );#}

                dmvi_categories.forEach(function(entry) {


                    if (entry['text'] == ui.item.label) {
                        {#                            $('#category_tree').jstree('toggle_node', entry['id']);#}

                        cascade_nodes(entry['id'])

                    }
                });
                return false;
            }
        });

        var active = true;

        $('#collapse-init').click(function () {
            if (active) {
                active = false;
                $('.panel-collapse').collapse('show');
                $('.panel-title').attr('data-toggle', '');
                $(this).text('-');
            } else {
                active = true;
                $('.panel-collapse').collapse('hide');
                $('.panel-title').attr('data-toggle', 'collapse');
                $(this).text('+');
            }
        });

        $('#accordion').on('show.bs.collapse', function () {
            if (active) $('#accordion .in').collapse('hide');
        });

{#        resize_box = function(){#}
{##}
{#            var photo = $("#photo");#}
{#            var photo_width = photo.width();#}
{#            var photo_height = photo.height();#}
{##}
{#            var p_b = $("#photo_background");#}
{##}
{#            console.log("x,y : " + photo_width + " " + photo_height)#}
{##}
{#            var max_length = (photo_height > photo_width) ? photo_height : photo_width;#}
{##}
{#            if (photo_width > photo_height) {#}
{#                p_b.height(photo_width);#}
{#                p_b.width(photo_width);#}
{##}
                {#                photo.css("height: auto");#}
                {#                photo.css("width: auto");#}
{#            } else {#}
{##}
{#                console.log("1 " + photo.width());#}
{#                photo.css("height: " + photo_width + "px; width: auto; display: block;");#}
{#                console.log("2 " + photo.width());#}
{##}
{##}
{#                photo_width = photo.width();#}
{#                p_b.height(photo_width);#}
{#                p_b.width(photo_width);#}
{#            }#}
{##}
{#            var top_margin = (p_b.height()/2) - (photo.height() /2);#}
{##}
{#            photo.css("margin-top:", top_margin);#}
{##}
{#            console.log("square : " + max_length);#}
{#            console.log("margin : " + top_margin);#}
{##}
{#        };#}

    });


    </script>



    <div class="container">

    <div class="col-xs-12 col-sm-6">
        <div class="jumbotron">
            <div id="photo_background" style="">
                <img id='photo' src="{{ image.imageurl }}"
                     style=' min-width:50px; min-height: 50px;width: 100%; height:auto; '>
            </div>
        </div>

        <div class="panel-footer">
            <ul class="pager">
                <li class="previous">
                    <a class="rota btn btn-default" data-degs="-90">← Rotate left</a>
                </li>

                <li>
                    <a class="rota btn btn-default" data-degs="reset">Reset</a>
                </li>

                <li>
                    <a class="btn btn-default" data-toggle="modal" data-target=".bs-example-modal-lg">Zoom</a>
                </li>

                <li class="next">
                    <a class="rota btn btn-default" data-degs="90">Rotate right →</a>
                </li>
            </ul>
        </div>

    </div><!--/span-->

    <div class="col-xs-12 col-sm-6">

    <div class="container-fluid">

    <div id="right-main">

    <div class="panel panel-default">
        <div class="panel-heading">
            <h1 style="margin:0 0 5px 0;color:#2b5688;font-size:15px">
                Search Oxford English Dictionary
            </h1>
        </div>
        <div class="panel-body">
            <div style="font:normal 13px/1.5 Arial;width:318px;height:98px;background:#f1f5fb;border:1px solid #d8e0f5;margin:0;padding:20px 10px 10px 10px;text-align:left">
                <form enctype="application/x-www-form-urlencoded" method="get" action="http://www.oed.com:80/search" name="oed_search" id="oed_search">
                    <label for="text">
                        Enter word or phrase:</label>
                    <input size="20" name="q" type="text" style="textfield">

                    </input><br/>
                    <input type="submit" value="Search"></input>
                </form>
            </div>
        </div>
    </div>


    <form action="{% url 'image.tags' %}" id="image-taggin-form" method="post">{% csrf_token %}
    {{ tag_form.non_field_errors }}
    <input type="hidden" name="image_id" value="{{ image_id }}" />


    <div class="panel-group" id="accordion">


    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">
                    Please select one or more categories which describe the image
                </a>
                <div class="navbar-right">
                    <div id="collapse-init" class="btn btn-primary btn-xs">
                        +
                    </div>
                </div>
            </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in">
            <div class="panel-body">



                <div id="add_category_body"></div>

                {#                <div id="categories" class="row-fluid">#}
                {#                    {% for field in category_form %}#}
                {#                        {{ field }}#}
                {#                        <label for="{{ field.auto_id }}">{{ field.label }}</label>#}
                {#                    {% endfor %}#}
                {#                </div>#}


                <div class="ui-widget">
                    <label for="tags">Tags: </label>
                    <input id="tags">
                </div>

                <div id="category_tree"></div>



                <script type="text/javascript">
                </script>

            </div>
            <div class="panel-footer">
                <ul class="pager">
                    <li class="next">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo"
                           class="btn btn-default">Next →</a>
                    </li>
                </ul>
            </div>
        </div>

    </div>



    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">
                    Please select the tags below which describe the image
                </a>
            </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse">
            <div class="panel-body">


                {% for key in image.tags %}
                    <input type="checkbox" value="{{ key }}" id="check{{ forloop.counter }}" />

                    <label for="check{{ forloop.counter }}">{{ key }}</label>
                {% empty %}
                    <p>(No previous tags found for this image)</p>
                {% endfor %}



                <div class="panel-heading">Please select the Flickr tags below which describe the image</div>
                <div class="panel-body">
                    {% for field in tag_form %}
                        {{ field }}
                        <label for="{{ field.auto_id }}">{{ field.label }}</label>
                    {% empty %}
                        (No relevant Flickr tags found for this image)
                    {% endfor %}
                </div>


            </div>
            <div class="panel-footer">
                <ul class="pager">
                    <li class="previous">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne"
                           class="btn btn-default">← Previous</a>
                    </li>
                    <li class="next">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree"
                           class="btn btn-default">Next →</a>
                    </li>
                </ul>


            </div>
        </div>

    </div>




    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree">
                    Please enter a new tag to describe the image
                </a>
            </h4>
        </div>
        <div id="collapseThree" class="panel-collapse collapse">
            <div class="panel-body">

                <div id="add_tag_body">

                </div>

                <div id="free_text" >
                    <label for="input_tag">Tag</label>
                    <input type="text" class="form-control" id="input_tag">
                    <div id="add_tag" class="btn btn-default">Add</div>
                </div>


            </div>
            <div class="panel-footer">


                <ul class="pager">
                    <li class="previous">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo"
                           class="btn btn-default">← Previous</a>
                    </li>
                    <li class="next">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseFour"
                           class="btn btn-default">Next →</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>






    <div class="panel panel-default">
        <div class="panel-heading">
            <h4 class="panel-title">
                <a data-toggle="collapse" data-parent="#accordion" href="#collapseFour">
                    Please enter a description of the image                                </a>
            </h4>
        </div>
        <div id="collapseFour" class="panel-collapse collapse">
            <div class="panel-body">

                <div id="free_text" class="row-fluid">
                    <label for="free-text-area">Description</label>
                    <textarea name="image_description" class="form-control"
                              rows="3" id="free-text-area"></textarea>
                </div>
            </div>

            <div class="panel-footer">
                <ul class="pager">


                    <li class="previous">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseThree"
                           class="btn btn-default">← Previous</a>
                    </li>
                    {% if user.is_authenticated %}

                        <li class="next">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseFive"
                               class="btn btn-default">Next →</a>
                        </li>
                    {% endif %}

                </ul>
            </div>
        </div>
    </div>


    {% if user.is_authenticated %}



        <div class="panel panel-default">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseFive">
                        Please select one or more creation techniques which are relevant to the image
                    </a>
                </h4>
            </div>
            <div id="collapseFive" class="panel-collapse collapse">
                <div class="panel-body">


                    <div class="row-fluid">

                        {% for field in create_tech_form %}
                            {{ field }}
                            <label for="{{ field.auto_id }}">{{ field.label }}</label>

                        {% endfor %}

                    </div>

                </div>
                <div class="panel-footer">
                    <ul class="pager">
                        <li class="previous">
                            <a data-toggle="collapse" data-parent="#accordion" href="#collapseFour"
                               class="btn btn-default">← Previous</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>


    {% else %}



        <div class="bs-component">
            <div class="alert alert-dismissable alert-info">
                <button type="button" class="close" data-dismiss="alert">×</button>
                <strong>Heads up!</strong>   You are not logged in. You can do more if you sign up!

            </div>
            <div id="source-button" class="btn btn-primary btn-xs" style="display: none;">&lt; &gt;</div></div>
    {% endif %}




    </div>
    <button type="submit" class="btn btn-primary btn-lg">Finish!</button>
    <div class="navbar-right">
        <div id="load_new_image" class="btn btn-primary">
            <a href="{% url 'image.random' %}">Skip</a>
        </div>
    </div>
    </form>

    </div>
    </div>

    {#            <div id="load_new_image" class="btn btn-info btn-lg">New Image</div>#}
    </div>

    </div>
    <hr>

    <div class="container">
        <div class="col-xs-12 col-sm-6">
            <div class="bs-example table-responsive">
                <table class="table table-striped table-hover ">
                    <tbody>
                    {% for mykey,value in image.items %}
                        {% if mykey != 'tags' %}

                            <tr><th>{{ mykey }}</th><td>{{ value }}</td></tr>

                        {% endif %}
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div>
        <table style="margin-top: 1em;">
            <thead>
            <tr>
                <th colspan="2" style="font-size: 110%; font-weight: bold; text-align: left; padding-left: 0.1em;">
                    Coordinates
                </th>
                <th colspan="2" style="font-size: 110%; font-weight: bold; text-align: left; padding-left: 0.1em;">
                    Dimensions
                </th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td style="width: 10%;"><b>X<sub>1</sub>:</b></td>
                <td style="width: 30%;"><input type="text" id="x1" value="-" /></td>
                <td style="width: 20%;"><b>Width:</b></td>
                <td><input type="text" value="-" id="w" /></td>
            </tr>
            <tr>
                <td><b>Y<sub>1</sub>:</b></td>
                <td><input type="text" id="y1" value="-" /></td>
                <td><b>Height:</b></td>
                <td><input type="text" id="h" value="-" /></td>
            </tr>
            <tr>
                <td><b>X<sub>2</sub>:</b></td>
                <td><input type="text" id="x2" value="-" /></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td><b>Y<sub>2</sub>:</b></td>
                <td><input type="text" id="y2" value="-" /></td>
                <td></td>
                <td></td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="container">
        <div id="preview" style="width: 100px; height: 100px; overflow: hidden;">
            <img src="{{ image.imageurl }}"/>
        </div>
    </div>

<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <img id='photo' src="{{ image.imageurl }}" style='width: 100%; height:auto; '>
            </div>
        </div>
    </div>
{% endblock %}