{% extends "base.html" %}
{% load staticfiles %}



{% block content %}
    <script type="text/javascript" xmlns="http://www.w3.org/1999/html">

        var all_image_ids = "{{ all_image_ids }}";
        var all_image_ids_list = all_image_ids.split(',');
        var start_id_index = 0;
        var end_id_index = {{ number_to_show }};
        var images_to_load = all_image_ids_list.slice(start_id_index, end_id_index);

        function read_next_batch(){

            if (end_id_index > (all_image_ids_list.length + 30)){
                alert('All images from the search have now been loaded.');
            } else {
                images_to_load = all_image_ids_list.slice(start_id_index, end_id_index);
                load_more(images_to_load.join(','));

                start_id_index = end_id_index;
                end_id_index += 30;
            }
        }

        function load_more(ids){
            $.ajax({
                type: "POST",
                url: "{% url 'get_image_data' %}",
                data: {
                    csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
                    image_ids: ids
                },
                success: function(data) {
                    console.log(data);

                    var table = $('#results_table');

                    for (var image_id in data) {
                        console.log(image_id);

                        var image_data = data[image_id];

                        var row = '<tr>'
                                + '<td>' +
                                '<a href="' + image_data['link'] + '" target="_blank">' +
                                '<img src="' + image_data['img']  + '"' +
                                'style="max-height: 80px; width:auto; display: block; margin: 0 auto">' +
                                '</a>'
                                + '</td>'
                                + '<td>' + image_data['author'] + '</td>'
                                + '<td>' + image_data['date'] + '</td>'
                                + '<td>' + image_data['page'] + '</td>'

                                + '<td><a href="{% url 'do_advanced_search' %}'
                                + '?book_id=' + image_data['book_id']
                                + '&csrfmiddlewaretoken={{ csrf_token }}"'
                                +  ' target="_blank">'
                                + image_data['title']  +
                                '</a></td>'
                                + '</tr>';

                        table.append($(row));
                    }
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert("Problem requesting Image: "+errorThrown+xhr.status+xhr.responseText);
                }
            });
        }

        $(document).ready(function(){

            $('#load_more').click(function(){
                read_next_batch()
            });

            read_next_batch();

        });
        $(window).load(function(){
        });
    </script>

    <h3>Images {{ query }}</h3>
    <div id="result-container">

        <div class="bs-example table-responsive">
            <table class="table table-striped table-hover" id="results_table">
                <tbody>
                <tr>
                    <th>
                        Image
                    </th>
                    <th>
                        Author
                    </th>
                    <th>
                        Date
                    </th>
                    <th>
                        Page
                    </th>
                    <th>
                        Title
                    </th>
                </tr>
{#                {% for image_key, image_data in results.results.advanced.items %}#}
{#                    <tr>#}
{#                        <th>#}
{#                            <a href="{{ image_data.link }}" target="_blank">#}
{#                                <img src="{{ image_data.img }}"#}
{#                                     style='max-height: 80px; width:auto; display: block; margin: 0 auto'>#}
{#                            </a>#}
{#                        </th>#}
{##}
{#                        <td>#}
{#                            {{ image_data.author }}#}
{#                        </td>#}
{#                        <td>#}
{#                            {{ image_data.date }}#}
{#                        </td>#}
{#                        <td>#}
{#                            {{ image_data.title }}#}
{#                        </td>#}
{#                    </tr>#}
{##}
{#                {% empty %}#}
{#                    <div class="bl_item">#}
{#                        <p>(No matches for your search)</p>#}
{#                    </div>#}
{#                {% endfor %}#}

                </tbody>
            </table>
        </div>
    </div>
    <hr>
    <div id="load_more" class="btn btn-primary" style="display: block; margin: 0 auto">Click to load more</div>


{% endblock %}